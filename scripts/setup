#!/usr/bin/env bash
mise trust
mise install

eval "$(/home/vscode/.local/bin/mise activate bash)"

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$REPO_ROOT"

if [ ! -d "$VENV_PATH" ]; then
	echo "[setup] Creating uv virtual environment at $VENV_PATH"
	uv venv --python 3.13 --prompt ha "$VENV_PATH"
else
	echo "[setup] Reusing existing virtual environment at $VENV_PATH"
fi

echo "[setup] Activating virtual environment"
source "$VENV_PATH/bin/activate"

echo "[setup] Installing base requirements via uv pip"
uv pip install -r requirements.txt
uv pip install -r requirements.test.txt
uv pip install -r requirements.dev.txt

source /workspaces/.venv/bin/activate

if ! grep -F "source /workspaces/.venv/bin/activate" ~/.zshrc >/dev/null 2>&1; then
	echo "[setup] Adding auto-activation to ~/.zshrc"
	echo "source /workspaces/.venv/bin/activate" >> ~/.zshrc
fi

if [ -z "${PYTHONPATH:-}" ]; then
	export PYTHONPATH="${PWD}/custom_components"
else
	export PYTHONPATH="${PYTHONPATH}:${PWD}/custom_components"
fi

if ! grep -F "export PYTHONPATH=\"\${PYTHONPATH}:${PWD}/custom_components\"" ~/.zshrc >/dev/null 2>&1; then
	echo "[setup] Adding PYTHONPATH to ~/.zshrc"
	echo "export PYTHONPATH=\"\${PYTHONPATH}:${PWD}/custom_components\"" >> ~/.zshrc
fi

echo "[setup] Done. Venv located at $VENV_PATH"
