#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$REPO_ROOT"

VENV_PATH="/workspaces/.venv"

if [ ! -d "$VENV_PATH" ]; then
	echo "[setup] Creating uv virtual environment at $VENV_PATH"
	uv venv --python 3.13 --prompt ha "$VENV_PATH"
else
	echo "[setup] Reusing existing virtual environment at $VENV_PATH"
fi

echo "[setup] Activating virtual environment"
source "$VENV_PATH/bin/activate"

echo "[setup] Installing base requirements via uv pip"
if [ -f requirements.txt ]; then
	uv pip install --requirement requirements.txt
else
	echo "[setup] Skipping requirements.txt (file not found)"
fi

echo "[setup] Installing test requirements via uv pip"
if [ -f requirements.test.txt ]; then
	uv pip install --requirement requirements.test.txt
else
	echo "[setup] Skipping requirements.test.txt (file not found)"
fi

source /workspaces/.venv/bin/activate

if ! grep -F "source /workspaces/.venv/bin/activate" ~/.zshrc >/dev/null 2>&1; then
	echo "[setup] Adding auto-activation to ~/.zshrc"
	echo "source /workspaces/.venv/bin/activate" >> ~/.zshrc
fi

if [ -z "${PYTHONPATH:-}" ]; then
	export PYTHONPATH="${PWD}/custom_components"
else
	export PYTHONPATH="${PYTHONPATH}:${PWD}/custom_components"
fi

if ! grep -F "export PYTHONPATH=\"\${PYTHONPATH}:${PWD}/custom_components\"" ~/.zshrc >/dev/null 2>&1; then
	echo "[setup] Adding PYTHONPATH to ~/.zshrc"
	echo "export PYTHONPATH=\"\${PYTHONPATH}:${PWD}/custom_components\"" >> ~/.zshrc
fi
echo "[setup] Installing Python tools via uv pip"
uv pip install black pycodestyle pydocstyle mypy pylint

echo "[setup] Done. Venv located at $VENV_PATH"
